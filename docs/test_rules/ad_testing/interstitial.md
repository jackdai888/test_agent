# 插屏广告测试规范

## 🎯 测试目标

验证插屏广告（Interstitial Ad）的加载、显示、关闭功能是否符合预期，确保用户体验良好。

## 📋 前置条件

1. **设备状态**
   - Android 设备已连接
   - 设备网络正常
   - 系统时间正确

2. **应用状态**
   - 测试应用已安装
   - 应用有网络权限
   - 广告 SDK 已初始化

3. **测试环境**
   - 使用测试广告 ID（避免影响真实数据）
   - 广告平台账号状态正常

## 🧪 测试用例

### TC-AD-001：广告加载测试

**测试步骤：**
1. 启动应用
2. 等待应用完全加载（主界面显示）
3. 等待插屏广告自动触发
4. 观察广告加载过程

**预期结果：**
- ✅ 广告在 3-10 秒内加载完成
- ✅ 广告内容完整显示
- ✅ 广告包含必要元素：
  - 广告图片/视频
  - "AD" 标识
  - 关闭按钮（或倒计时）
  - 跳过按钮（如果支持）

**失败处理：**
- ❌ 如果超过 10 秒未加载：检查网络连接
- ❌ 如果广告显示不完整：截图并报告
- ❌ 如果没有 "AD" 标识：合规问题，必须修复

---

### TC-AD-002：关闭按钮测试

**测试步骤：**
1. 等待广告完全加载
2. 查找关闭按钮（通常在右上角）
3. 检查关闭按钮是否可点击
4. 点击关闭按钮
5. 观察应用状态

**预期结果：**
- ✅ 关闭按钮清晰可见
- ✅ 关闭按钮位置符合规范（右上角或固定位置）
- ✅ 点击关闭按钮后：
  - 广告立即消失（< 1秒）
  - 应用返回主界面
  - 无广告残留元素
  - 应用功能正常

**关闭按钮定位：**
```python
# 常见的关闭按钮特征
- resource_id: "*close*", "*dismiss*"
- text: "×", "关闭", "Close", "Skip"
- content-desc: "关闭", "Close"
- class: "android.widget.ImageButton"
```

---

### TC-AD-003：倒计时功能测试

**测试步骤：**
1. 观察广告显示时的倒计时
2. 记录倒计时开始时间
3. 等待倒计时结束
4. 验证关闭按钮可用

**预期结果：**
- ✅ 倒计时清晰显示（如 "5秒后可关闭"）
- ✅ 倒计时准确（误差 < 1秒）
- ✅ 倒计时结束后关闭按钮立即可用
- ✅ 倒计时期间其他区域可能可点击（跳转广告）

---

### TC-AD-004：广告点击测试

**测试步骤：**
1. 广告加载完成后
2. 点击广告内容区域（非关闭按钮）
3. 观察行为

**预期结果：**
- ✅ 跳转到广告落地页或应用商店
- ✅ 记录点击事件
- ✅ 可以返回应用（按返回键）

---

### TC-AD-005：状态验证测试

**测试步骤：**
1. 关闭广告后
2. 检查应用界面状态
3. 测试应用功能
4. 检查内存和性能

**预期结果：**
- ✅ 应用界面完整显示
- ✅ 无广告 View 残留
- ✅ 应用功能正常可用
- ✅ 无内存泄漏（关闭前后内存对比）
- ✅ UI 响应正常（无卡顿）

---

## 🐛 常见问题与解决方案

### 问题 1：广告加载失败

**现象：**
- 广告长时间不显示
- 显示加载错误

**可能原因：**
1. 网络连接问题
2. 广告 ID 配置错误
3. 广告库存不足
4. 广告 SDK 版本问题

**解决方案：**
```python
# 检查步骤
1. 检查网络连接：ping 广告服务器
2. 验证广告 ID：查看日志中的请求参数
3. 查看错误码：分析 SDK 返回的错误信息
4. 更新 SDK：确保使用最新版本
```

---

### 问题 2：关闭按钮不可见

**现象：**
- 找不到关闭按钮
- 关闭按钮位置异常

**可能原因：**
1. 倒计时未结束
2. 广告素材问题
3. UI 适配问题

**解决方案：**
```python
# 等待策略
1. 等待倒计时结束（通常 5 秒）
2. 使用多种定位方式：
   - 按 ID 查找
   - 按文本查找（×, 关闭）
   - 按坐标查找（右上角区域）
3. 截图并报告问题
```

---

### 问题 3：关闭后有残留

**现象：**
- 广告 View 还在
- 黑屏或白屏
- 界面遮挡

**可能原因：**
1. 广告 View 未正确销毁
2. SDK 关闭逻辑问题

**解决方案：**
```python
# 验证步骤
1. 检查 View 层级：get_ui_elements()
2. 查找残留元素：搜索广告相关 class
3. 强制返回：press_key("back")
4. 记录问题并报告
```

---

## 📊 性能指标

### 加载性能
- **首次加载**：< 5 秒
- **重复加载**：< 3 秒
- **超时判定**：10 秒

### 内存占用
- **加载前内存**：记录基准值
- **加载中内存**：增量 < 50MB
- **关闭后内存**：恢复到基准值 ± 10MB

### 用户体验
- **关闭响应**：< 500ms
- **界面恢复**：< 1 秒
- **无卡顿**：FPS > 30

---

## 🎯 自动化测试代码示例

### 完整测试流程

```python
# 测试插屏广告
def test_interstitial_ad():
    # 1. 连接设备
    connect_devices()
    
    # 2. 启动应用
    launch_app("com.example.app")
    
    # 3. 等待广告加载
    wait_for_element("广告容器", timeout=10)
    
    # 4. 验证广告元素
    elements = get_ui_elements({"text": "AD"})
    assert "AD" in elements, "缺少广告标识"
    
    # 5. 等待关闭按钮
    wait_for_element("关闭按钮", timeout=6)
    
    # 6. 点击关闭
    click_element("关闭", by="text")
    
    # 7. 验证广告关闭
    time.sleep(1)
    elements = get_ui_elements()
    assert "广告" not in elements, "广告未关闭"
    
    # 8. 验证应用状态
    assert app_is_functional(), "应用状态异常"
```

---

## 📝 测试报告模板

```markdown
# 插屏广告测试报告

**测试时间：** 2025-11-10 17:00:00
**测试人员：** AI Agent
**应用版本：** 1.0.0
**广告 SDK：** AdMob 21.0.0

## 测试结果

| 用例ID | 测试项 | 结果 | 备注 |
|--------|--------|------|------|
| TC-AD-001 | 广告加载 | ✅ PASS | 加载时间 3.2s |
| TC-AD-002 | 关闭按钮 | ✅ PASS | 响应正常 |
| TC-AD-003 | 倒计时 | ✅ PASS | 5秒倒计时准确 |
| TC-AD-004 | 广告点击 | ✅ PASS | 正确跳转 |
| TC-AD-005 | 状态验证 | ✅ PASS | 无残留 |

**通过率：** 100%
**总耗时：** 2 分 30 秒

## 发现问题
无

## 建议
广告加载性能良好，用户体验符合预期。
```

---

## 🔗 相关文档

- [广告 SDK 集成文档](../../api/ad_sdk_integration.md)
- [测试用例模板](../best_practices/test_case_template.md)
- [性能测试指南](../best_practices/performance_testing.md)

---

**版本：** 1.0  
**更新日期：** 2025-11-10  
**维护者：** 测试团队
